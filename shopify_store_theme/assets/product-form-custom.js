customElements.get("product-form-custom-card")||customElements.define("product-form-custom-card",class extends HTMLElement{constructor(){super(),this.unsubscribe=!1,this.form=this.querySelector("form"),this.form.querySelector("[name=id]").disabled=!1,this.form.addEventListener("submit",this.onSubmitHandler.bind(this)),this.cart=document.querySelector("cart-notification")||document.querySelector("cart-drawer"),this.submitButton=this.querySelector('[type="submit"]'),document.querySelector("cart-drawer")&&this.submitButton.setAttribute("aria-haspopup","dialog")}getDefaultDelivery=async()=>{var r=document.querySelector('[name="default_shipping_address"]')?.value;if(0<r?.length){var r=JSON.parse(r),s=Array.from(document.querySelectorAll("fieldset")).map(e=>{if(0<e.querySelectorAll("input").length)return Array.from(e.querySelectorAll("input")).find(e=>e.checked).value}),o=document.querySelector('[name="product_type"]')?.value,i=s[0];let e=1,t=1;switch(o){case"Cards":e=1,t=i.includes("Standard")?1:2;break;case"Gifts":e=2;break;case"Alcohol":e=3;break;default:e=1}s=[{product_type:e,product_size:t,product_quantity:1,address:{line:`${r.address1}, ${r.address2?r.address2+",":""} `+r.city,postcode:r.zip,country:countryToCode(r.country)},attached_products:[]}];return(await fetch("/apps/scribblerApi/v1/delivery-options",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(s)})).json()}};saveItemChange=async(e,t,r)=>{return fetch("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,quantity:e,properties:r})}).then(e=>e.json()).catch(e=>{throw e})};removeItem=async e=>{return fetch("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache",cache:"no-store"},body:JSON.stringify({id:e,quantity:0})}).then(e=>e.json()).catch(e=>{throw e})};addNewItem=async(e,t,r)=>{return fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,quantity:e,properties:r})}).then(e=>e.json()).catch(e=>{throw e})};async addToCart(e){var t,r,s,o,i,a;e.preventDefault(),"true"!==this.submitButton.getAttribute("aria-disabled")&&(this.handleErrorMessage(),this.submitButton.setAttribute("aria-disabled",!0),this.submitButton.classList.add("loading"),this.querySelector(".loading-overlay__spinner").classList.remove("hidden"),e=document.querySelector('input[name="quantity"]').value,t=document.querySelector('input[name="id"]').value,document.querySelector('[name="product_type"]')?.value,o=document.querySelector('[name="properties[_shipping_address]"]')?.value,r=sessionStorage.getItem("editor_item_key"),sessionStorage.getItem("editor_state"),s=JSON.parse(sessionStorage.getItem("editor_properties"))||{},document.querySelector('[name="properties[_json_editor_state]"]')?.value&&(s._json_editor_state=document.querySelector('[name="properties[_json_editor_state]"]')?.value,s._production_pdf=document.querySelector('[name="properties[_production_pdf]"]')?.value,s._user_pdf=document.querySelector('[name="properties[_user_pdf]"]')?.value),!s._shipping_id&&0<o.length&&0<(o=await this.getDefaultDelivery())?.length&&0<o[0]?.delivery_options?.length&&(i=new Date(o[0].delivery_options[0].deliverFrom),a=new Date(o[0].delivery_options[0].deliverTo),s._shipping_id=o[0].delivery_options[0].delivery_id,s._shipping_name=o[0].delivery_options[0].delivery_name,o[0].delivery_options[0].deliverFrom!==o[0].delivery_options[0].deliverTo&&(s["Delivery from"]=`${i.getDate()}/${i.getMonth()+1}/`+i.getFullYear()),s["Delivery from"]=`${a.getDate()}/${a.getMonth()+1}/`+a.getFullYear()),r?(t===r.split(":")[0]?await this.saveItemChange(e,r,s):(await this.removeItem(r),await this.addNewItem(e,t,s)),sessionStorage.removeItem("editor_item_key"),sessionStorage.removeItem("editor_variant_id"),sessionStorage.removeItem("editor_state"),sessionStorage.removeItem("editor_properties"),sessionStorage.removeItem("editor_quantity")):await this.addNewItem(e,t,s),window.location=window.routes.cart_url)}onSubmitHandler(t){t.preventDefault(),this.submitButton.classList.add("loading"),this.querySelector(".loading-overlay__spinner").classList.remove("hidden"),this.unsubscribe&&this.unsubscribe.unsubscribe("CARD_GENERATED"),this.unsubscribe=window.eventBus.subscribe("CARD_GENERATED",e=>{this.addToCart(t)});var e=this.form.querySelector('input[name="id"]').value;window.eventBus.publish("GENERATE_CARD",{variantId:e,wait_for:!1})}handleErrorMessage(e=!1){this.errorMessageWrapper=this.errorMessageWrapper||this.querySelector(".product-form__error-message-wrapper"),this.errorMessageWrapper&&(this.errorMessage=this.errorMessage||this.errorMessageWrapper.querySelector(".product-form__error-message"),this.errorMessageWrapper.toggleAttribute("hidden",!e),e)&&(this.errorMessage.textContent=e)}});